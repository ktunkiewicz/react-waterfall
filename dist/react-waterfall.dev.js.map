{"version":3,"file":"react-waterfall.dev.js","sources":["../src/Components/Provider.js","../src/Components/Prevent.js","../src/helpers/connect.js","../src/helpers/subscriptions.js","../src/helpers/devtools.js","../src/index.js"],"sourcesContent":["// @flow\n/* eslint-disable no-undef */\n\nimport React, { Component } from 'react'\n\nimport type { CreateProvider, State } from '../types'\n\ntype Props = { children: React$Node, initialState?: {}, actionsCreators?: {} }\n\nconst EnhancedProvider: CreateProvider = (\n  setProvider,\n  Provider,\n  config,\n  subscriptions,\n  middlewares,\n) =>\n  class EnhancedProvider extends Component<Props, State> {\n    constructor(props) {\n      super()\n      this.state = props.initialState || config.initialState\n      this.setInternalState(this.state)\n      const actionsCreators = props.actionsCreators || config.actionsCreators\n      this.state.reactWaterfallActions = this.buildActions(actionsCreators)\n      this.initializedMiddlewares = middlewares.map(middleware => middleware(\n        { initialState: this.getInternalState(), actionsCreators },\n        this,\n        this.getActions(),\n      ))\n      setProvider(this)\n    }\n\n    getInternalState() {\n      return this.internalState\n    }\n\n    setInternalState(state) {\n      this.internalState = state\n    }\n\n    getActions() {\n      const { reactWaterfallActions } = this.state\n      return reactWaterfallActions\n    }\n\n    internalState = {};\n    initializedMiddlewares = [];\n\n    buildActions(actionsCreators) {\n      return Object.keys(actionsCreators).reduce(\n        (r, actionName) => ({\n          ...r,\n          [actionName]: (...args) => {\n            const result = actionsCreators[actionName](\n              this.getInternalState(),\n              this.getActions(),\n              ...args,\n            )\n            return this.handleActionResult(actionName, result, ...args)\n          },\n        }),\n        {},\n      )\n    }\n\n    handleActionResult(actionName, result, ...args) {\n      // empty or non-object response from action does nothing to state\n      if (!result || typeof result !== 'object') return Promise.resolve(result)\n      // object, but not promise, response from actions means the object is a new partial state\n      if (!result.then) {\n        this.updateState(actionName, result, ...args)\n        return Promise.resolve(result)\n      }\n      // promise response from action must be handled to see what it returns\n      if (result.then) {\n        result.then(promiseResult => this.handleActionResult(actionName, promiseResult, ...args))\n      }\n      return result\n    }\n\n    updateState(action, result, ...args) {\n      const newState = { ...this.state, ...result }\n      subscriptions.getSubscriptions().forEach(fn => fn(action, result, ...args))\n      this.setInternalState(newState)\n      this.initializedMiddlewares.forEach(m => m(action, newState, ...args))\n      this.setState(newState)\n    }\n\n    render() {\n      return <Provider value={this.state}>{this.props.children}</Provider>\n    }\n  }\n\nexport default EnhancedProvider\n","// @flow\n/* eslint-disable no-undef */\n\nimport { PureComponent } from 'react'\n\ntype Props = {\n  renderComponent: ({}) => React$Node,\n}\n\nexport default class Prevent extends PureComponent<Props> {\n  render() {\n    const { renderComponent, ...rest } = this.props\n    return renderComponent(rest)\n  }\n}\n","// @flow\n/* eslint-disable no-undef */\n\nimport * as React from 'react'\nimport Prevent from '../Components/Prevent'\n\nimport type { CreateConnect } from '../types'\n\nconst connect: CreateConnect = Consumer => mapStateToProps => WrappedComponent => {\n  const renderComponent = props => <WrappedComponent {...props} />\n  const ConnectedComponent = props => (\n    <Consumer>\n      {stateAndActions => {\n        if (!stateAndActions || !stateAndActions.reactWaterfallActions) {\n          const componentName = (\n            // $FlowFixMe\n            WrappedComponent.prototype &&\n            WrappedComponent.prototype.constructor &&\n            WrappedComponent.prototype.constructor.name\n          ) || null\n          const componentHint = typeof componentName === 'string' ? ` (${componentName})` : ''\n          // eslint-disable-next-line no-console,max-len\n          console.error(`Connected component${componentHint} must be wrapped with ${'<Provider />'}`)\n          return\n        }\n        const { reactWaterfallActions, ...state } = stateAndActions\n        const filteredState = mapStateToProps(state || {}, reactWaterfallActions)\n        return (\n          <Prevent\n            renderComponent={renderComponent}\n            {...props}\n            {...filteredState}\n          />\n        )\n      }}\n    </Consumer>\n  )\n\n  ConnectedComponent.displayName = `Connect(${WrappedComponent.displayName ||\n    WrappedComponent.name ||\n    'Unknown'})`\n\n  return ConnectedComponent\n}\n\nexport default connect\n","// @flow\n/* eslint-disable no-undef */\n\nimport type { Subscription } from '../types'\n\nexport default class Subscriptions {\n  subscriptions = []\n\n  getSubscriptions = () => this.subscriptions\n\n  subscribe = (subscription: Subscription) => {\n    this.subscriptions = [...this.subscriptions, subscription]\n  }\n\n  unsubscribe = (subscription: Subscription) => {\n    this.subscriptions = this.subscriptions.filter(subscriber => subscriber !== subscription)\n  }\n}\n","let id = 0\n\nexport default ({ initialState }, self) => {\n  const reduxDevTools = window.devToolsExtension\n\n  const instanceID = id\n  id += 1\n\n  const name = `react-waterfall - ${instanceID}`\n  const features = {\n    jump: true,\n  }\n\n  const devTools = reduxDevTools.connect({ name, features })\n\n  devTools.subscribe(data => {\n    switch (data.type) {\n      case 'START':\n        devTools.init(initialState)\n        break\n      case 'RESET':\n        self.setState(initialState)\n        break\n      case 'DISPATCH':\n        switch (data.payload.type) {\n          case 'JUMP_TO_STATE':\n          case 'JUMP_TO_ACTION': {\n            self.setState(JSON.parse(data.state))\n            break\n          }\n          default:\n            break\n        }\n        break\n      default:\n        break\n    }\n  })\n\n  return (action, state, ...arg) => {\n    devTools.send({ type: action, ...arg }, state, {}, instanceID)\n  }\n}\n","// @flow\n/* eslint-disable no-undef */\n\nimport { createContext } from 'react'\n\nimport createProvider from './Components/Provider'\nimport createConnect from './helpers/connect'\nimport Subscriptions from './helpers/subscriptions'\nimport devtools from './helpers/devtools'\n\nimport type {\n  CreateStore,\n  Context,\n  SetProvider,\n  ProviderType,\n} from './types'\n\nconst defaultMiddlewares =\n  process.env.NODE_ENV === 'development' &&\n  typeof window !== 'undefined' &&\n  window.devToolsExtension\n    ? [devtools]\n    : []\n\nclass Store {\n  subscriptions = new Subscriptions()\n\n  provider: ?ProviderType = null\n  setProvider: SetProvider = self => {\n    this.provider = self\n  }\n\n  create(config, middlewares) {\n    const context: Context = createContext()\n    const Provider = createProvider(\n      this.setProvider,\n      context.Provider,\n      config,\n      this.subscriptions,\n      [...middlewares, ...defaultMiddlewares],\n    )\n    const connect = createConnect(context.Consumer, this)\n    return {\n      Provider,\n      connect,\n      subscribe: this.subscriptions.subscribe,\n      unsubscribe: this.subscriptions.unsubscribe,\n    }\n  }\n}\n\n\nconst createStore: CreateStore = (config, middlewares = []) => {\n  const store = new Store()\n  return store.create(config, middlewares)\n}\n\nexport default createStore\n"],"names":["EnhancedProvider","setProvider","Provider","config","subscriptions","middlewares","props","state","initialState","setInternalState","actionsCreators","reactWaterfallActions","buildActions","initializedMiddlewares","map","middleware","getInternalState","getActions","internalState","Object","keys","reduce","r","actionName","args","result","handleActionResult","Promise","resolve","then","updateState","promiseResult","action","newState","getSubscriptions","forEach","fn","m","setState","React","children","Component","Prevent","renderComponent","rest","PureComponent","connect","React.createElement","ConnectedComponent","stateAndActions","componentName","prototype","WrappedComponent","constructor","name","componentHint","error","filteredState","mapStateToProps","displayName","Subscriptions","subscription","filter","subscriber","id","self","reduxDevTools","window","devToolsExtension","instanceID","features","devTools","subscribe","data","type","init","payload","JSON","parse","arg","send","defaultMiddlewares","process","devtools","Store","provider","context","createContext","createProvider","createConnect","Consumer","unsubscribe","createStore","store","create"],"mappings":"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"}